<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة المشرف - العقود</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family:'Tajawal',sans-serif;background:#f9f9f9;padding:20px;color:#004d40; }
    h2 { text-align:center;color:#004d40; }
    .contract-box { background:#fff;border:2px solid #004d40;padding:20px;border-radius:12px;margin:20px 0; }
    .info-row { display:flex;justify-content:space-between;font-size:14px;margin-bottom:8px; }
    .btn-download { background:#00796b;color:#fff;padding:8px 18px;border:none;border-radius:6px;cursor:pointer;font-size:14px; }
    .btn-download:hover { background:#004d40; }
    .footer { text-align:center;margin-top:20px;font-size:13px;color:#555; }
  </style>
</head>
<body>

<h2>لوحة المشرف - العقود</h2>

<div id="contractsList"></div>

<script>
let contractStart = 9876;
let clients = JSON.parse(localStorage.getItem("clientsData") || "[]");

if (clients.length === 0) {
  document.getElementById("contractsList").innerHTML = "<p>لا يوجد عملاء حالياً.</p>";
} else {
  clients.forEach((client, index) => {
    const contractNo = contractStart + index + 1;
    const div = document.createElement("div");
    div.className = "contract-box";
    div.innerHTML = `
      <div class="info-row">
        <div><strong>اسم العميل:</strong> ${client.name}</div>
        <div><strong>رقم الهوية:</strong> ${client.id}</div>
      </div>
      <div class="info-row">
        <div><strong>رقم العقد:</strong> ${contractNo}</div>
        <div><strong>تاريخ العقد:</strong> ${client.date || '—'}</div>
      </div>
      <div class="info-row">
        <div><strong>حالة العقد:</strong> ${client.status}</div>
        <div><strong>الوقت:</strong> ${client.time || '—'}</div>
      </div>
      <div style="text-align:center;margin-top:10px;">
        <button class="btn-download" onclick="generatePDF(${index})">📄 تحميل العقد بصيغة PDF</button>
      </div>
    `;
    document.getElementById("contractsList").appendChild(div);
  });
}

function generatePDF(index) {
  const client = clients[index];
  const contractNo = contractStart + index + 1;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'p', unit:'pt', format:'a4'});

  const content = `
    بسم الله الرحمن الرحيم\n\n
    المملكة العربية السعودية\n
    سرعة تملك العقار والحلول التمويلية المتكاملة\n
    ترخيص رقم: 1100042624\n
    الرياض\n\n

    رقم العقد: ${contractNo}
    التاريخ: ${client.date || '—'}  الوقت: ${client.time || '—'}

    عقد اتفاقية إنهاء إجراءات تمويل عقاري من جهة تمويلية

    بيانات العميل:
    - الاسم: ${client.name}
    - رقم الهوية: ${client.id}
    - تاريخ الميلاد: ${client.birth}
    - الجوال: ${client.mobile}
    - الموقع: ${client.location || 'لم يسمح بمشاركة موقعه وتم إدخاله يدوياً'}

    الإجابات:
    ${client.answers ? client.answers.map(a => `• ${a.question}: ✅ ${a.answer}`).join('\n') : 'لا توجد إجابات مسجلة'}

    الحالة: ${client.status === 'approved' ? '✅ تم الموافقة على العقد' : '❌ تم رفض العقد'}
    
    المادة 9: هذا العقد يُعد سندًا تنفيذيًا كما نصت المادة (9) من نظام التعاملات الإلكترونية.

    التوقيع الآلي للطرف الأول: نايف المطيري
    توقيع الطرف الثاني: ${client.status === 'approved' ? '✅ موافق' : '❌ غير موافق'}

    التاريخ الهجري: سيتم طباعته من الفوتر
  `;

  doc.setFont('Arial');
  doc.setFontSize(12);
  doc.text(content, 30, 40, {maxWidth: 540});
  doc.save(`عقد_${client.name}.pdf`);
}
</script>

<div class="footer" id="footerTime">📅 يتم تحميل التاريخ الهجري والوقت تلقائياً...</div>

<script>
async function updateDateTime(){
  const now = new Date();
  const time = now.toLocaleTimeString('ar-EG');
  try {
    const res = await fetch(`https://api.aladhan.com/v1/gToH?date=${now.getDate()}-${now.getMonth()+1}-${now.getFullYear()}`);
    const hijri = (await res.json()).data.hijri.date;
    document.getElementById("footerTime").innerHTML = `📅 التاريخ الهجري: ${hijri}<br>⏰ الوقت: ${time}<br>جميع الحقوق محفوظة لشركة سرعة تملك العقار`;
  } catch {
    document.getElementById("footerTime").textContent = "تعذر تحميل التاريخ.";
  }
}
updateDateTime();
</script>

</body>
</html>