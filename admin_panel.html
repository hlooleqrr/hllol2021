<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù - Ø§Ù„Ø¹Ù‚ÙˆØ¯</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {font-family: 'Tajawal', sans-serif; background: #f9f9f9; padding: 30px; color: #004d40;}
    h2 {text-align: center; margin-bottom: 30px;}
    table {width: 100%; border-collapse: collapse; margin-bottom: 30px;}
    th, td {border: 1px solid #ccc; padding: 10px; text-align: center;}
    th {background: #00796b; color: #fff;}
    button {background: #00796b; color: #fff; border: none; padding: 6px 15px; border-radius: 5px; cursor: pointer;}
    button:hover {background: #004d40;}
    .footer {text-align: center; font-size: 13px; color: #777; margin-top: 30px;}
  </style>
</head>
<body>

<h2>ğŸ“‹ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© - Ø³Ø±Ø¹Ø© ØªÙ…Ù„Ùƒ Ø§Ù„Ø¹Ù‚Ø§Ø±</h2>

<table id="contractsTable">
  <thead>
    <tr>
      <th>Ø±Ù‚Ù…</th>
      <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
      <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th>
      <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</th>
      <th>Ø§Ù„ÙˆÙ‚Øª</th>
      <th>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ</th>
      <th>ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯</th>
    </tr>
  </thead>
  <tbody id="contractsBody">
    <!-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙˆÙ„Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ -->
  </tbody>
</table>

<div class="footer">
  Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø´Ø±ÙƒØ© Ø³Ø±Ø¹Ø© ØªÙ…Ù„Ùƒ Ø§Ù„Ø¹Ù‚Ø§Ø± Â© 2025
</div>

<script>
  const { jsPDF } = window.jspdf;

  async function getHijriDate(dateObj) {
    try {
      const d = `${dateObj.getDate()}-${dateObj.getMonth() + 1}-${dateObj.getFullYear()}`;
      const res = await fetch(`https://api.aladhan.com/v1/gToH?date=${d}`);
      const data = await res.json();
      return data.data.hijri.date;
    } catch {
      return 'ØªØ¹Ø°Ø±';
    }
  }

  const allContracts = JSON.parse(localStorage.getItem('approvedContracts') || '[]');
  allContracts.sort((a, b) => new Date(b.time) - new Date(a.time));

  const tbody = document.getElementById('contractsBody');
  let counter = 1;

  allContracts.forEach(async contract => {
    const tr = document.createElement('tr');
    const hijri = await getHijriDate(new Date(contract.time));
    const time = new Date(contract.time).toLocaleTimeString('ar-EG');

    tr.innerHTML = `
      <td>${counter++}</td>
      <td>${contract.name}</td>
      <td>${contract.id}</td>
      <td>${contract.contractNo}</td>
      <td>${time}</td>
      <td>${hijri}</td>
      <td><button onclick='downloadPDF(${JSON.stringify(contract).replace(/"/g, '&quot;')})'>ğŸ“„ ØªØ­Ù…ÙŠÙ„</button></td>
    `;
    tbody.appendChild(tr);
  });

  function downloadPDF(contract) {
    const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
    const time = new Date(contract.time).toLocaleTimeString('ar-EG');

    const html = `
      <div dir="rtl" style="font-family:'Tajawal';color:#004d40;padding:30px;">
        <h2 style="text-align:center;">Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…</h2>
        <p><strong>Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</strong><br>Ø³Ø±Ø¹Ø© ØªÙ…Ù„Ùƒ Ø§Ù„Ø¹Ù‚Ø§Ø± ÙˆØ§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©<br>ØªØ±Ø®ÙŠØµ: 1100042624 - Ø§Ù„Ø±ÙŠØ§Ø¶</p>
        <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯:</strong> ${contract.contractNo}</p>
        <p><strong>Ø§Ù„ÙˆÙ‚Øª:</strong> ${time}</p>
        <hr>
        <p><strong>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${contract.name}</p>
        <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©:</strong> ${contract.id}</p>
        <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</strong> ${contract.birth}</p>
        <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</strong> ${contract.mobile}</p>
        <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${contract.location}</p>
        <br>
        <p>ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ.</p>
        <br><br>
        <p><strong>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„:</strong> ØªÙ… Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¢Ù„ÙŠÙ‹Ø§ Ù…Ù† Ù†Ø§ÙŠÙ Ø§Ù„Ù…Ø·ÙŠØ±ÙŠ</p>
        <p><strong>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ:</strong> âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</p>
        <br>
        <div style="background:#fff3cd;border:1px solid #ffeeba;padding:10px;border-radius:8px;font-size:14px;color:#856404;">
          âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ ÙŠÙØ¹Ø¯ Ø³Ù†Ø¯Ù‹Ø§ ØªÙ†ÙÙŠØ°ÙŠÙ‹Ø§ ÙƒÙ…Ø§ Ù†ØµÙ‘Øª Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ù…Ø§Ø¯Ø© (9) Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©
        </div>
      </div>
    `;
    doc.html(html, {
      callback: function (pdf) {
        pdf.save(`Ø¹Ù‚Ø¯_${contract.contractNo}.pdf`);
      },
      x: 10,
      y: 10,
      html2canvas: { scale: 0.8 }
    });
  }
</script>

</body>
</html>