<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة المشرف - العقود</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body{font-family:'Tajawal',sans-serif;background:#f9f9f9;padding:20px;color:#004d40;}
    .contract-box{background:#fff;border:2px solid #004d40;padding:20px;border-radius:12px;margin-bottom:40px;}
    h2{text-align:center;margin-bottom:20px;color:#004d40;}
    .info-row{display:flex;justify-content:space-between;margin-bottom:10px;font-size:15px;}
    .info-row div{width:48%;}
    .btn-download{background:#00796b;color:#fff;padding:8px 20px;border:none;border-radius:6px;cursor:pointer;font-size:14px;}
    .btn-download:hover{background:#004d40;}
    .footer{text-align:center;margin-top:30px;font-size:13px;color:#555;}
  </style>
</head>
<body>

  <h2>العقود المعتمدة</h2>

  <div id="contractContainer" class="contract-box">
    <div style="text-align:center;font-weight:bold;font-size:20px;">بسم الله الرحمن الرحيم</div>

    <div class="info-row" style="margin-top:20px;">
      <div>
        <div>المملكة العربية السعودية</div>
        <div>سرعة تملك العقار والحلول التمويلية المتكاملة</div>
        <div>ترخيص رقم: 1100042624</div>
        <div>الرياض</div>
      </div>
      <div style="text-align:left;">
        <div id="contractNo">رقم العقد: </div>
        <div id="hijriDate">التاريخ الهجري: </div>
        <div id="timeNow">الوقت: </div>
      </div>
    </div>

    <h3 style="text-align:center;margin-top:30px;">عقد اتفاقية إنهاء إجراءات تمويل عقاري من جهة تمويلية</h3>

    <!-- بيانات مثال؛ تُولد فعليًا من localStorage للعملاء -->
    <div id="clientData" style="margin-top:30px;"></div>

    <p style="margin-top:30px;" id="contractBody">
      نص كامل لبنود العقد التي تم عرضها للعميل مع البنود من 1 إلى 12 بنفس التنسيق الرسمي.
    </p>

    <div style="margin-top:40px;">
      <p><strong>توقيع الطرف الأول:</strong> تم التوقيع آليًا من نايف المطيري</p>
      <p><strong>توقيع الطرف الثاني:</strong> ✅ تمت الموافقة من العميل</p>
    </div>

    <div style="background:#fff3cd;border:1px solid #ffeeba;padding:10px;border-radius:8px;margin-top:20px;font-size:14px;color:#856404;">
      ⚠️ هذا العقد يُعد سندًا تنفيذيًا كما نصّت عليه المادة (9) من نظام التعاملات الإلكترونية
    </div>

    <div class="footer" id="footerTime">جارٍ تحميل التاريخ الهجري والوقت...</div>
  </div>

  <div style="text-align:center;">
    <button class="btn-download" onclick="downloadPDF()">📄 تحميل PDF</button>
  </div>

  <script>
    /* ========= منطق ترقيم العقود تلقائيًا ========= */
    function getNextContractNumber(){
      const start = 9876;                        // أول رقم عقد
      let last = localStorage.getItem('lastContractNo');
      if(!last){ last = start; }
      const next = parseInt(last) + 1;
      localStorage.setItem('lastContractNo', next);
      return next;
    }
    const contractNumber = getNextContractNumber();
    document.getElementById('contractNo').textContent = 'رقم العقد: ' + contractNumber;

    /* ========= بيانات العميل (مثال) ========= */
    const sampleClient = JSON.parse(localStorage.getItem('currentClient') || '{}');
    // لو ما عندك تخزين عميل حالي اجعل البيانات ثابتة كمثال:
    if(!sampleClient.name){
      Object.assign(sampleClient,{
        name:'سعود عبدالله المطيري',
        id:'1234567890',
        birth:'1405/01/01',
        mobile:'0501234567',
        location:'لم يسمح بمشاركة موقعه وتم تسجيل الموقع يدويًا من قبله كما يلي: الرياض - حي لبن'
      });
    }
    document.getElementById('clientData').innerHTML = `
      <p><strong>اسم العميل:</strong> ${sampleClient.name}</p>
      <p><strong>رقم الهوية:</strong> ${sampleClient.id}</p>
      <p><strong>تاريخ الميلاد:</strong> ${sampleClient.birth}</p>
      <p><strong>رقم الجوال:</strong> ${sampleClient.mobile}</p>
      <p><strong>العنوان:</strong> ${sampleClient.location}</p>
      <p><strong>حالة العقد:</strong> ✅ تمت الموافقة</p>
    `;

    /* ========= التاريخ الهجري + الوقت للفوتر ========= */
    async function updateDateTime(){
      const now = new Date();
      const time = now.toLocaleTimeString('ar-EG');
      try{
        const res = await fetch(`https://api.aladhan.com/v1/gToH?date=${now.getDate()}-${now.getMonth()+1}-${now.getFullYear()}`);
        const hijri = (await res.json()).data.hijri.date; // مثل 15-07-1446
        document.getElementById('hijriDate').textContent = 'التاريخ الهجري: ' + hijri;
        document.getElementById('timeNow').textContent  = 'الوقت: ' + time;
        document.getElementById('footerTime').innerHTML = `📅 التاريخ الهجري: ${hijri}<br>⏰ الوقت: ${time}<br>جميع الحقوق محفوظة لشركة سرعة تملك العقار`;
      }catch(e){
        document.getElementById('footerTime').textContent = 'تعذر تحميل التاريخ.';
      }
    }
    updateDateTime();

    /* ========= توليد PDF مطابق للعقد ========= */
    function downloadPDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation:'p',unit:'pt',format:'a4'});
      doc.html(document.getElementById('contractContainer'),{
        callback:pdf=>pdf.save(`عقد_${contractNumber}.pdf`),
        x:10,y:10,html2canvas:{scale:0.7}
      });
    }
  </script>
</body>
</html>