<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة المشرف - العقود</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {font-family: 'Tajawal', sans-serif; background: #f9f9f9; padding: 30px; color: #004d40;}
    h2 {text-align: center; margin-bottom: 30px;}
    table {width: 100%; border-collapse: collapse; margin-bottom: 30px;}
    th, td {border: 1px solid #ccc; padding: 10px; text-align: center;}
    th {background: #00796b; color: #fff;}
    button {background: #00796b; color: #fff; border: none; padding: 6px 15px; border-radius: 5px; cursor: pointer;}
    button:hover {background: #004d40;}
    .footer {text-align: center; font-size: 13px; color: #777; margin-top: 30px;}
  </style>
</head>
<body>

<h2>📋 العقود المعتمدة - سرعة تملك العقار</h2>

<table id="contractsTable">
  <thead>
    <tr>
      <th>رقم</th>
      <th>اسم العميل</th>
      <th>رقم الهوية</th>
      <th>رقم العقد</th>
      <th>الوقت</th>
      <th>التاريخ الهجري</th>
      <th>تحميل العقد</th>
    </tr>
  </thead>
  <tbody id="contractsBody">
    <!-- البيانات تولد تلقائياً -->
  </tbody>
</table>

<div class="footer">
  جميع الحقوق محفوظة لشركة سرعة تملك العقار © 2025
</div>

<script>
  const { jsPDF } = window.jspdf;

  async function getHijriDate(dateObj) {
    try {
      const d = `${dateObj.getDate()}-${dateObj.getMonth() + 1}-${dateObj.getFullYear()}`;
      const res = await fetch(`https://api.aladhan.com/v1/gToH?date=${d}`);
      const data = await res.json();
      return data.data.hijri.date;
    } catch {
      return 'تعذر';
    }
  }

  const allContracts = JSON.parse(localStorage.getItem('approvedContracts') || '[]');
  allContracts.sort((a, b) => new Date(b.time) - new Date(a.time));

  const tbody = document.getElementById('contractsBody');
  let counter = 1;

  allContracts.forEach(async contract => {
    const tr = document.createElement('tr');
    const hijri = await getHijriDate(new Date(contract.time));
    const time = new Date(contract.time).toLocaleTimeString('ar-EG');

    tr.innerHTML = `
      <td>${counter++}</td>
      <td>${contract.name}</td>
      <td>${contract.id}</td>
      <td>${contract.contractNo}</td>
      <td>${time}</td>
      <td>${hijri}</td>
      <td><button onclick='downloadPDF(${JSON.stringify(contract).replace(/"/g, '&quot;')})'>📄 تحميل</button></td>
    `;
    tbody.appendChild(tr);
  });

  function downloadPDF(contract) {
    const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
    const time = new Date(contract.time).toLocaleTimeString('ar-EG');

    const html = `
      <div dir="rtl" style="font-family:'Tajawal';color:#004d40;padding:30px;">
        <h2 style="text-align:center;">بسم الله الرحمن الرحيم</h2>
        <p><strong>المملكة العربية السعودية</strong><br>سرعة تملك العقار والحلول التمويلية المتكاملة<br>ترخيص: 1100042624 - الرياض</p>
        <p><strong>رقم العقد:</strong> ${contract.contractNo}</p>
        <p><strong>الوقت:</strong> ${time}</p>
        <hr>
        <p><strong>اسم العميل:</strong> ${contract.name}</p>
        <p><strong>رقم الهوية:</strong> ${contract.id}</p>
        <p><strong>تاريخ الميلاد:</strong> ${contract.birth}</p>
        <p><strong>رقم الجوال:</strong> ${contract.mobile}</p>
        <p><strong>العنوان:</strong> ${contract.location}</p>
        <br>
        <p>تمت الموافقة على جميع البنود من الطرف الثاني.</p>
        <br><br>
        <p><strong>توقيع الطرف الأول:</strong> تم التوقيع آليًا من نايف المطيري</p>
        <p><strong>توقيع الطرف الثاني:</strong> ✅ تمت الموافقة</p>
        <br>
        <div style="background:#fff3cd;border:1px solid #ffeeba;padding:10px;border-radius:8px;font-size:14px;color:#856404;">
          ⚠️ هذا العقد يُعد سندًا تنفيذيًا كما نصّت عليه المادة (9) من نظام التعاملات الإلكترونية
        </div>
      </div>
    `;
    doc.html(html, {
      callback: function (pdf) {
        pdf.save(`عقد_${contract.contractNo}.pdf`);
      },
      x: 10,
      y: 10,
      html2canvas: { scale: 0.8 }
    });
  }
</script>

</body>
</html>